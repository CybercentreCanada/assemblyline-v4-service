name: tests

trigger: ["*"]
pr: ["*"]

pool:
  vmImage: "ubuntu-20.04"

variables:
  # Try to checkout the matching branch, if the command fails, don't care.
  BRANCH_NAME: $[coalesce(variables['System.PullRequest.SourceBranch'], variables['System.PullRequest.TargetBranch'], replace(variables['Build.SourceBranch'], 'refs/heads/', ''))]

resources:
  containers:
    - container: elasticsearch
      image: cccs/elasticsearch:8.10.2
      env:
        ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        DISCOVERY_TYPE: "single-node"
        ELASTIC_PASSWORD: "devpass"
      ports:
        - 9200:9200
  repositories:
    - repository: assemblyline-base
      type: github
      endpoint: github-repo-sa
      name: CybercentreCanada/assemblyline-base
    - repository: assemblyline-core
      type: github
      endpoint: github-repo-sa
      name: CybercentreCanada/assemblyline-core

jobs:
  - job: run_test
    strategy:
      matrix:
        python3_9:
          python.version: "3.9"
        Python3_10:
          python.version: "3.10"
        Python3_11:
          python.version: "3.11"
        Python3_12:
          python.version: "3.12"
    timeoutInMinutes: 10
    services:
      elasticsearch: elasticsearch

    steps:
      - task: UsePythonVersion@0
        displayName: Set python version
        inputs:
          versionSpec: "$(python.version)"
      - checkout: self
      - checkout: assemblyline-base
      - checkout: assemblyline-core
      - script: |
          set -x # echo on
          [ ! -d "$(pwd)/test" ] && echo "No test found" && exit

          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev libfuzzy-dev python3-dev git tesseract-ocr
          sudo mkdir -p /etc/assemblyline/
          sudo mkdir -p /var/cache/assemblyline/
          sudo cp pipelines/config.yml /etc/assemblyline
          sudo chmod a+rw /var/cache/assemblyline/
          sudo env "PATH=$PATH" python -m pip install --no-cache-dir -U pip cython setuptools wheel
        workingDirectory: $(Pipeline.Workspace)/s/assemblyline-v4-service
        displayName: Setup Environment
      - script: |
          set -x # echo on
          [ ! -d "$(pwd)/test" ] && echo "No test found" && exit

          git checkout -b $BRANCH_NAME -t origin/$BRANCH_NAME || true
          git status
          sudo env "PATH=$PATH" python -m pip install --no-cache-dir -e .
        displayName: Install assemblyline
        workingDirectory: $(Pipeline.Workspace)/s/assemblyline-base
      - script: |
          set -x # echo on
          [ ! -d "$(pwd)/test" ] && echo "No test found" && exit

          git checkout -b $BRANCH_NAME -t origin/$BRANCH_NAME || true
          git status
          sudo env "PATH=$PATH" python -m pip install --no-cache-dir -e .
        workingDirectory: $(Pipeline.Workspace)/s/assemblyline-core
        displayName: Install assemblyline_core
      - script: |
          set -x # echo on
          [ ! -d "$(pwd)/test" ] && echo "No test found" && exit

          sudo env "PATH=$PATH" python -m pip install --no-cache-dir -e .[updater]
          [ -f $(pwd)/test/requirements.txt ] && sudo env "PATH=$PATH" python -m pip install --no-cache-dir -r $(pwd)/test/requirements.txt
        workingDirectory: $(Pipeline.Workspace)/s/assemblyline-v4-service
        displayName: Setup environment for service base
      - script: |
          set -x # echo on
          python -m pytest -p no:cacheprovider --durations=10 -rsx -svvv --disable-warnings
        displayName: Test
        # Run tests from /test directory because that is how the release pipeline runs them
        workingDirectory: $(Pipeline.Workspace)/s/assemblyline-v4-service/test
